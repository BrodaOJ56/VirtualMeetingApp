{% extends 'layout.html' %}

{% block title %}Meeting Room{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="row">
    <div class="col">
      <h2>Meeting Room - {{ meeting.title }}</h2>
    </div>
  </div>
  <div class="row mt-4">
    <div class="col-8">
      <div id="localVideoContainer">
        <video id="localVideo" autoplay muted></video>
      </div>
    </div>
    <div class="col-4">
      <div id="remoteVideoContainer">
        <!-- Remote videos will be displayed here -->
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Add Bootstrap and other dependencies here, if not already included -->
<script>
  const meetingId = "{{ meeting.id }}";
  const participantToken = '{{ participant_token }}';
  const localVideo = document.getElementById('localVideo');
  const remoteVideoContainer = document.getElementById('remoteVideoContainer');

  // Function to initialize the video call
  async function initializeVideoCall() {
    try {
      // Get user media (video and audio)
      const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = stream;

      // Create WebSocket connection
      const webSocketProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
      const webSocketPath = `/ws/meeting/${meetingId}/`;
      const webSocketURL = `${webSocketProtocol}${window.location.host}${webSocketPath}`;
      const webSocket = new WebSocket(webSocketURL);

      // Event listener for WebSocket open
      webSocket.onopen = () => {
        console.log('WebSocket connection opened');
        // Send participant information to server
        webSocket.send(JSON.stringify({ type: 'join', token: participantToken }));
      };

      // Event listener for WebSocket message
      webSocket.onmessage = handleWebSocketMessage;

      // Function to handle WebSocket message
      function handleWebSocketMessage(event) {
        const message = JSON.parse(event.data);
        handleSignalingMessage(message);
      }

      // Function to handle signaling messages (offer, answer, ice_candidate)
      function handleSignalingMessage(message) {
        switch (message.type) {
          case 'offer':
            // Handle offer and create answer
            // ...
            break;
          case 'answer':
            // Handle answer
            // ...
            break;
          case 'ice_candidate':
            // Handle ICE candidate
            // ...
            break;
          default:
            console.warn('Invalid signaling message type:', message.type);
        }
      }

      // Function to send signaling messages to the server
      function sendSignalingMessage(message) {
        webSocket.send(JSON.stringify(message));
      }
    } catch (error) {
      console.error('Error accessing camera or microphone:', error);
    }
  }

  // Call the function to initialize the video call
  initializeVideoCall();
</script>
{% endblock %}
